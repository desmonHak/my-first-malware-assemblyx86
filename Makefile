NASM=nasm
GCC=gcc
ARCH=32
ASM_FLAG=-g -f win$(ARCH)
C_FLAG=-g -m$(ARCH)
TARGET=code

init:
	echo copy C:\Windows\System32\kernel32.dll .
	echo dlltool  -mi386 -k -d kernel32.def -l libkernel32.a
	echo dlltool  -mi386 -d kernel32.def -D kernel32.dll -l kernel32.o


	$(NASM) $(ASM_FLAG) $(TARGET).asm -l $(TARGET).lst -o $(TARGET).o
	gcc $(C_FLAG) $(TARGET).o -o $(TARGET).exe
	echo ld -e _main -m i386pe -o $(TARGET).exe $(TARGET).o kernel32.o

	echo objdump -x -s  -t -r -M intel,i386 -D $(TARGET).exe -h > dissas_code.asm
	objdump -x -s  -t -r -M intel,i386 -D code.exe -h > dissas_code.asm
